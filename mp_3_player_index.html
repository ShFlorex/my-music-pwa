<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple MP3 Player (Offline / GitHub Pages)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Noto Sans',sans-serif;background:linear-gradient(180deg,#061025 0%, #081427 100%);color:#e6eef6}
    .app{max-width:980px;margin:28px auto;padding:20px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.7)}
    h1{margin:0 0 8px;font-size:20px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--card);border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#031025}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .left{flex:1}
    input[type=file]{display:none}
    .playlist{margin-top:14px;background:var(--glass);padding:12px;border-radius:8px;max-height:420px;overflow:auto}
    .track{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;margin-bottom:6px;border:1px dashed rgba(255,255,255,0.02)}
    .track.dragging{opacity:0.5}
    .track .title{flex:1}
    .small{font-size:13px;color:var(--muted)}
    .seek{width:100%;margin-top:10px}
    .playlist .index{width:28px;text-align:center;color:var(--muted)}
    .badge{padding:4px 6px;border-radius:6px;background:rgba(255,255,255,0.02);font-size:12px}
    .row{display:flex;gap:8px;align-items:center}
    .playback{display:flex;gap:8px;align-items:center;margin-top:10px}
    .textarea{width:100%;min-height:80px;padding:8px;border-radius:8px;background:#071024;border:1px solid rgba(255,255,255,0.02);color:inherit}
    footer{margin-top:12px;font-size:13px;color:var(--muted)}
    a.link{color:var(--accent);text-decoration:none}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="left">
        <h1>MP3 Player — เลือกเพลงหรือรันต่อเนื่อง (Offline / GitHub)</h1>
        <div class="small">รองรับ: เพิ่มไฟล์จากเครื่อง (เล่นออฟไลน์ทันที) หรือใส่ URL/พาธไฟล์ MP3 ใน repo (เก็บเป็น playlist ได้)</div>
      </div>
      <div>
        <label class="btn">
          เพิ่มไฟล์จากเครื่อง
          <input id="fileInput" type="file" accept="audio/*" multiple />
        </label>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
      <div style="flex:1;min-width:320px">
        <div class="controls">
          <button id="playPause" class="btn primary">Play</button>
          <button id="prev" class="btn">Prev</button>
          <button id="next" class="btn">Next</button>
          <button id="shuffleBtn" class="btn">Shuffle: Off</button>
          <button id="repeatBtn" class="btn">Repeat: Off</button>
          <button id="saveBtn" class="btn">Save playlist</button>
          <button id="clearBtn" class="btn">Clear</button>
        </div>

        <div class="playback">
          <div class="row" style="flex:1">
            <div class="small">Now:</div>
            <div id="nowTitle" style="margin-left:8px;flex:1">-</div>
            <div id="nowTime" class="small muted">0:00 / 0:00</div>
          </div>
        </div>

        <input id="seek" class="seek" type="range" min="0" max="100" value="0" />

        <div style="margin-top:10px">
          <div class="small">เพิ่มจาก URL (เช่น /songs/song.mp3 หรือ https://... )</div>
          <textarea id="urls" class="textarea" placeholder="วาง URL หรือพาธไฟล์ MP3 แต่ละบรรทัด"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="addUrls" class="btn">เพิ่มจาก URL</button>
            <button id="loadSaved" class="btn">โหลด playlist ที่บันทึก</button>
            <button id="export" class="btn">Export JSON</button>
          </div>
        </div>

      </div>

      <div style="width:360px;min-width:260px">
        <div class="small" style="margin-bottom:6px">Playlist (ลากเพื่อจัดลำดับ)</div>
        <div id="playlist" class="playlist"></div>
      </div>
    </div>

    <footer>
      วิธีใช้งานสั้น ๆ: 1) เพิ่มไฟล์จากเครื่องเพื่อเล่นออฟไลน์ 2) หรือวาง URL/พาธไฟล์ในกล่อง 3) จัดลำดับด้วยการลาก 4) กด Save เพื่อเก็บ playlist (หมายเหตุ: ไฟล์จากเครื่องจะไม่ถูกบันทึกข้ามเซสชัน)
      &nbsp;|&nbsp; รองรับการนำไปวางใน GitHub Pages: ใส่ mp3 ใน repo แล้วใช้พาธสัมพัทธ์ เช่น <code>/songs/mysong.mp3</code>
    </footer>
  </div>

  <script>
    // Simple MP3 player script
    const fileInput = document.getElementById('fileInput');
    const playlistEl = document.getElementById('playlist');
    const playPauseBtn = document.getElementById('playPause');
    const nextBtn = document.getElementById('next');
    const prevBtn = document.getElementById('prev');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const repeatBtn = document.getElementById('repeatBtn');
    const clearBtn = document.getElementById('clearBtn');
    const saveBtn = document.getElementById('saveBtn');
    const addUrlsBtn = document.getElementById('addUrls');
    const urlsBox = document.getElementById('urls');
    const nowTitle = document.getElementById('nowTitle');
    const nowTime = document.getElementById('nowTime');
    const seek = document.getElementById('seek');
    const loadSaved = document.getElementById('loadSaved');
    const exportBtn = document.getElementById('export');

    let audio = new Audio();
    audio.preload = 'metadata';
    let tracks = []; // {name, url, source:'file'|'url'}
    let index = -1;
    let playing = false;
    let shuffle = false;
    let repeat = false;
    let shuffleOrder = [];
    let playedSet = new Set();

    function renderPlaylist(){
      playlistEl.innerHTML = '';
      tracks.forEach((t,i)=>{
        const tr = document.createElement('div');
        tr.className = 'track';
        tr.draggable = true;
        tr.dataset.i = i;
        tr.innerHTML = `
          <div class="index">${i+1}</div>
          <div class="title">${escapeHtml(t.name)}</div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-sm" data-action="play">Play</button>
            <button class="btn btn-sm" data-action="remove">✕</button>
          </div>
        `;
        playlistEl.appendChild(tr);

        tr.addEventListener('click', (ev)=>{
          const a = ev.target.closest('button')?.dataset?.action;
          if(a==='play'){
            playIndex(i);
          }else if(a==='remove'){
            removeIndex(i);
          }
        });

        // drag & drop handlers for reorder
        tr.addEventListener('dragstart', (e)=>{
          tr.classList.add('dragging');
          e.dataTransfer.setData('text/plain', i);
        });
        tr.addEventListener('dragend', ()=>tr.classList.remove('dragging'));
      });

      // allow dropping on playlist
      playlistEl.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const after = getDragAfterElement(playlistEl, e.clientY);
        const dragging = document.querySelector('.dragging');
        if(after==null) playlistEl.appendChild(dragging);
        else playlistEl.insertBefore(dragging, after);
      });

      playlistEl.addEventListener('drop', (e)=>{
        e.preventDefault();
        // rebuild tracks order from DOM
        const newTracks = [];
        playlistEl.querySelectorAll('.track').forEach(node=>{
          const i = Number(node.dataset.i);
          newTracks.push(tracks[i]);
        });
        tracks = newTracks;
        renderPlaylist();
      });
    }

    function getDragAfterElement(container, y){
      const draggableElements = [...container.querySelectorAll('.track:not(.dragging)')];
      return draggableElements.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset < 0 && offset > closest.offset){
          return {offset, element: child};
        }else return closest;
      }, {offset: Number.NEGATIVE_INFINITY}).element;
    }

    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    fileInput.addEventListener('change', (e)=>{
      const files = Array.from(e.target.files);
      files.forEach(f=>{
        const url = URL.createObjectURL(f);
        tracks.push({name: f.name, url, source:'file'});
      });
      renderPlaylist();
      if(index===-1 && tracks.length>0) playIndex(0);
    });

    addUrlsBtn.addEventListener('click', ()=>{
      const lines = urlsBox.value.split('\n').map(s=>s.trim()).filter(Boolean);
      lines.forEach(l=>{
        const name = l.split('/').pop().split('?')[0];
        tracks.push({name, url:l, source:'url'});
      });
      urlsBox.value = '';
      renderPlaylist();
      if(index===-1 && tracks.length>0) playIndex(0);
    });

    function playIndex(i){
      if(i<0||i>=tracks.length) return;
      index = i;
      const t = tracks[i];
      audio.src = t.url;
      audio.play().catch(()=>{});
      playing = true;
      updateUI();
    }

    function removeIndex(i){
      const wasCurrent = (i===index);
      tracks.splice(i,1);
      if(wasCurrent){
        if(tracks.length===0){ pauseAndReset(); }
        else playIndex(Math.min(i, tracks.length-1));
      } else {
        if(i<index) index--; // shift current index
      }
      renderPlaylist();
    }

    function pauseAndReset(){ audio.pause(); audio.src=''; index=-1; playing=false; updateUI(); }

    playPauseBtn.addEventListener('click', ()=>{
      if(!audio.src && tracks.length>0){ playIndex(0); return; }
      if(playing){ audio.pause(); playing=false; }
      else{ audio.play().catch(()=>{}); playing=true; }
      updateUI();
    });

    nextBtn.addEventListener('click', ()=>playNext());
    prevBtn.addEventListener('click', ()=>{
      if(audio.currentTime>2) { audio.currentTime = 0; }
      else { playPrev(); }
    });

    shuffleBtn.addEventListener('click', ()=>{
      shuffle = !shuffle;
      shuffleBtn.textContent = 'Shuffle: ' + (shuffle? 'On' : 'Off');
      if(shuffle) buildShuffleOrder();
    });

    repeatBtn.addEventListener('click', ()=>{
      repeat = !repeat;
      repeatBtn.textContent = 'Repeat: ' + (repeat? 'On' : 'Off');
    });

    clearBtn.addEventListener('click', ()=>{
      tracks.forEach(t=>{ if(t.source==='file') URL.revokeObjectURL(t.url); });
      tracks = []; index = -1; audio.pause(); audio.src=''; renderPlaylist(); updateUI();
    });

    saveBtn.addEventListener('click', ()=>{
      // Save only URL-based tracks (can't persist local blob URLs across sessions)
      const saveTracks = tracks.filter(t=>t.source==='url').map(t=>({name:t.name,url:t.url}));
      localStorage.setItem('mp3player_playlist', JSON.stringify(saveTracks));
      alert('Saved ' + saveTracks.length + ' tracks to localStorage (only URL-based tracks are stored).');
    });

    loadSaved.addEventListener('click', ()=>{
      const s = localStorage.getItem('mp3player_playlist');
      if(!s){ alert('ไม่มี playlist ที่บันทึกไว้'); return; }
      try{
        const saved = JSON.parse(s);
        saved.forEach(t=>tracks.push({name:t.name,url:t.url,source:'url'}));
        renderPlaylist();
        alert('โหลด playlist เสร็จแล้ว');
      }catch(e){ alert('ไฟล์ playlist เสียหาย'); }
    });

    exportBtn.addEventListener('click', ()=>{
      const exportData = tracks.map(t=>({name:t.name,url:t.url,source:t.source}));
      const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'playlist.json';
      a.click();
    });

    audio.addEventListener('loadedmetadata', ()=>{
      updateTimeText();
    });

    audio.addEventListener('timeupdate', ()=>{
      updateTimeText();
      if(audio.duration) seek.value = Math.floor((audio.currentTime/audio.duration)*100);
    });

    seek.addEventListener('input', ()=>{
      if(audio.duration) audio.currentTime = (seek.value/100)*audio.duration;
    });

    audio.addEventListener('ended', ()=>{
      if(repeat){ audio.currentTime = 0; audio.play(); return; }
      playNext();
    });

    function updateTimeText(){
      if(index>=0 && tracks[index]) nowTitle.textContent = tracks[index].name; else nowTitle.textContent='-';
      const cur = formatTime(audio.currentTime || 0);
      const dur = formatTime(audio.duration || 0);
      nowTime.textContent = `${cur} / ${dur}`;
      playPauseBtn.textContent = playing? 'Pause' : 'Play';
      renderPlaylist();
    }

    function formatTime(t){
      if(!isFinite(t)) return '0:00';
      const m = Math.floor(t/60); const s = Math.floor(t%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    function playNext(){
      if(tracks.length===0) return;
      if(shuffle){
        if(shuffleOrder.length===0) buildShuffleOrder();
        const nextIdx = shuffleOrder.shift();
        if(nextIdx==null) { if(repeat){ buildShuffleOrder(); playNext(); } return; }
        playIndex(nextIdx);
      } else {
        let ni = index+1;
        if(ni>=tracks.length){ if(repeat) ni = 0; else { audio.pause(); playing=false; updateUI(); return; } }
        playIndex(ni);
      }
    }

    function playPrev(){
      if(tracks.length===0) return;
      let pi = index-1;
      if(pi<0){ if(repeat) pi = tracks.length-1; else { audio.currentTime=0; return; } }
      playIndex(pi);
    }

    function buildShuffleOrder(){
      shuffleOrder = tracks.map((_,i)=>i).filter(i=>i!==index);
      for(let i=shuffleOrder.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [shuffleOrder[i],shuffleOrder[j]]=[shuffleOrder[j],shuffleOrder[i]]; }
    }

    function updateUI(){
      playPauseBtn.textContent = playing? 'Pause' : 'Play';
      shuffleBtn.textContent = 'Shuffle: ' + (shuffle? 'On' : 'Off');
      repeatBtn.textContent = 'Repeat: ' + (repeat? 'On' : 'Off');
      renderPlaylist();
    }

    // initialize
    renderPlaylist();
  </script>
</body>
</html>
